# Prompt 9 — детектор смены режима риска (drift) по истории Monte Carlo

## Что добавлено
- Для `stressTest` хранится история запусков Monte Carlo: `mcHistory` (FIFO, cap = 50).
- Каждая запись содержит: `ts`, параметры запуска (`horizonMonths`, `iterations`, `sigmaIncome`, `sigmaExpense`, `shock`) и результат (`ruinProb`, `p10`, `p50`, `p90`).
- При успешном Monte Carlo расчёте обновляется `mcLast` и добавляется новая точка в `mcHistory`.

## Что такое «смена режима»
Смена режима — это **сдвиг в серии оценок риска** между запусками Monte Carlo (`ruinProb`), а не одноразовый шум.

В MVP используется CUSUM/Page-Hinkley-подобный детектор:
- вход: `series = mcHistory.map(x => x.ruinProb)`;
- параметры: `delta`, `lambda`, `minN`;
- выход: `driftDetected`, `driftTs`, `driftScore (0..1)`.

Если данных меньше `minN`, детектор возвращает нейтральный результат:
- `driftDetected = false`
- `driftScore = 0`.

## Интеграция в Cosmos turbulence
Для планеты `stressTest` в Cosmos теперь используется формула:

- `ruin = ruinProb` (в нормировке `0..1`),
- `uncertainty = clamp((p90 - p10) / max(1, p50))`,
- `drift = driftScore`,
- `turbulence = clamp(0.60 * ruin + 0.25 * uncertainty + 0.15 * drift, 0..1)`.

В панели Monte Carlo для `stressTest`:
- при обнаружении дрейфа показывается сигнал: «Смена режима риска обнаружена» и время фиксации;
- иначе выводится нейтральный статус.

## Ограничения
- Детектор фиксирует **сдвиг оценки риска**, но не объясняет **причину** (изменение входных данных, волатильности, шоков и т.д.).
- Сигнал чувствителен к частоте запусков и качеству входов, поэтому его нужно читать вместе с параметрами конкретных прогонов.
